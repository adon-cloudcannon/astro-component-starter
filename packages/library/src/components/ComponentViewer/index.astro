---
const { component_examples = [], title = "" } = Astro.props;

import Button from "@skele/components/elements/Button/index.astro";

function getBodyPadding(spacing: string): string {
  switch (spacing) {
    case "all":
      return "padding: var(--space-md";
    case "top":
      return "padding-top: var(--space-md)";
    case "sides":
      return "padding-left: var(--space-md); padding-right: var(--space-md);";
    default:
      return "";
  }
}

function formatBlocksYaml(blocks: any): string {
  if (Array.isArray(blocks) && blocks.length > 0) {
    const yaml = blocks
      .map((block, idx) => {
        const blockYaml = Object.entries(block)
          .map(([key, val]) => `  ${key}: ${val}`)
          .join("\n");

        return `- # Block ${idx + 1}\n${blockYaml}`;
      })
      .join("\n");

    return `\nblocks:\n${yaml}`;
  } else if (blocks && typeof blocks === "object" && Object.keys(blocks).length > 0) {
    const yaml = Object.entries(blocks)
      .map(([key, val]) => `  ${key}: ${val}`)
      .join("\n");

    return `\nblocks:\n${yaml}`;
  } else {
    return "";
  }
}

const componentModules = import.meta.glob("../../../../shared/components/**/index.astro", {
  eager: true,
});

const componentMap: Record<string, any> = {};

Object.entries(componentModules).forEach(([filePath, module]) => {
  const pathParts = filePath.split("/");
  const componentName = pathParts[pathParts.length - 2];

  if (componentName && componentName !== "components") {
    componentMap[componentName] = module;
  }
});

async function loadComponent(componentName: string) {
  try {
    const module = componentMap[componentName];

    if (!module) {
      console.warn(
        `Component ${componentName} not found. Available components: ${Object.keys(componentMap).join(", ")}`
      );
      return null;
    }

    return module.default;
  } catch (error) {
    console.error(`Failed to load component ${componentName}:`, error);
    return null;
  }
}
---

<style>
  @import "styles.pcss";
</style>

<div class="component-viewer">
  <div class="previews">
    {
      component_examples.map(async (example: any, idx: number) => {
        const bodyPadding = getBodyPadding(example.data.spacing);
        const exampleName = example.data.title;
        const exampleId = `component-${exampleName.toLowerCase().replace(/\s+/g, "-")}-${idx}`;

        const Component = example.data.component
          ? await loadComponent(example.data.component)
          : null;
        const blocks = example.data.blocks || {};

        return (
          <>
            <div id={exampleId} class:list={[`preview`, `${idx === 0 ? "active" : ""}`]}>
              <div class="container" style={bodyPadding}>
                {Component && Array.isArray(blocks) ? (
                  blocks.map((block: any, blockIdx: number) => (
                    <Component key={blockIdx} {...block} />
                  ))
                ) : (
                  <Component {...blocks} />
                )}
              </div>
            </div>

            <div class="code" id={`code-${exampleId}`}>
              <pre>
                <code class="language-yaml">{formatBlocksYaml(example.data.blocks)}</code>
              </pre>
            </div>
          </>
        );
      })
    }

    {
      component_examples.length > 0 && (
        <nav class="controls">
          <div>
            {component_examples.length > 1 && (
              <>
                <label for={`${title.toLowerCase().replace(/\s+/g, "-")}-examples`} class="sr-only">
                  Examples:
                </label>
                <select class="select" id={`${title.toLowerCase().replace(/\s+/g, "-")}-examples`}>
                  {component_examples.map((example: any, idx: number) => {
                    const exampleName = example.data.title;
                    const exampleId = `component-${exampleName.toLowerCase().replace(/\s+/g, "-")}-${idx}`;

                    return <option value={exampleId}>{exampleName}</option>;
                  })}
                </select>
              </>
            )}
          </div>
          <div>
            <Button
              type="ghost"
              label="View Code"
              size="lg"
              icon={{ name: "hero/code-bracket" }}
              hideText={true}
            />
          </div>
        </nav>
      )
    }
  </div>
</div>
