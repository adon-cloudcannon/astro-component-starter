---
import { Picture } from "astro:assets";

const { source, alt, sizes, widths, width, height, priority, ...htmlAttributes } = Astro.props;

let imageSrc = source;
let imageWidth = width;
let imageHeight = height;
let useInferSize = false;
let shouldRender = true;

const isRemoteUrl =
  typeof source === "string" && (source.startsWith("http://") || source.startsWith("https://"));

const imageFiles = import.meta.glob("/src/assets/**/*", {
  import: "default",
}) as Record<string, any>;

if (
  typeof source === "string" &&
  (source.startsWith("/images/") || source.startsWith("/component-library/images/"))
) {
  let assetPath;

  if (source.startsWith("/component-library/images/")) {
    assetPath = source.replace("/component-library/images/", "component-library/images/");
  } else {
    assetPath = source.replace("/images/", "");
  }

  const imageKey = Object.keys(imageFiles).find((key) => key.endsWith(assetPath));

  if (imageKey && imageFiles[imageKey]) {
    imageSrc = await imageFiles[imageKey]();

    if (!imageWidth) imageWidth = imageSrc.width;
    if (!imageHeight) imageHeight = imageSrc.height;
  } else {
    console.warn(`Local image not found for path: ${source}`);

    imageWidth = imageWidth || 800;
    imageHeight = imageHeight || 450;
  }
}

// For remote URLs, try to validate the image exists before using inferSize
if (isRemoteUrl) {
  if (!imageWidth || !imageHeight) {
    imageWidth = imageWidth || 800;
    imageHeight = imageHeight || 450;

    try {
      const response = await fetch(source, { method: "HEAD" });

      if (response.ok) {
        const contentType = response.headers.get("content-type");
        const isValidImage = contentType && contentType.startsWith("image/");

        if (isValidImage) {
          useInferSize = true;
        } else {
          console.warn(`Invalid content-type for image: ${source} (${contentType})`);
          useInferSize = false;
          shouldRender = false;
        }
      } else {
        console.warn(`Image not accessible: ${source} (${response.status})`);
        useInferSize = false;
        shouldRender = false;
      }
    } catch (error) {
      console.warn(`Could not validate image URL: ${source}`, error);
      useInferSize = false;
      shouldRender = false;
    }
  } else {
    useInferSize = true;
  }
}
---

{
  shouldRender ? (
    <Picture
      src={imageSrc}
      alt={alt}
      widths={widths}
      sizes={sizes}
      formats={["avif", "webp"]}
      width={imageWidth}
      height={imageHeight}
      loading={priority ? "eager" : "lazy"}
      decoding={priority ? "sync" : "async"}
      fetchpriority={priority ? "high" : undefined}
      inferSize={useInferSize}
      pictureAttributes={{
        ...htmlAttributes,
      }}
    />
  ) : (
    <picture {...htmlAttributes}>
      <img src={source} alt={alt || ""} />
    </picture>
  )
}
